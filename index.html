<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متجر وفرنهالك تك - اشتراكاتك الرقمية</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts (Cairo) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #000000;
            color: #e5e7eb;
        }
        .product-card {
            background-color: #1a1a1a;
            border: 1px solid #2e2e2e;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.1), 0 4px 6px -2px rgba(16, 185, 129, 0.05);
            border-color: #10b981;
        }
        .btn-primary {
            background-color: #10b981;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #059669;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
        }
        .btn-primary:disabled {
            background-color: #047857;
            cursor: not-allowed;
            opacity: 0.8;
        }
        .btn-game {
             background-color: #f59e0b;
             color: #1e293b;
        }
        .btn-game:hover:not(:disabled) {
            background-color: #d97706;
             box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        }
        .btn-game:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .modal-content {
             background: #1a1a1a;
             border: 1px solid #2e2e2e;
        }
        
        .loader {
            border: 4px solid rgba(243, 244, 246, 0.3);
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #game-canvas {
            background-color: #000;
            border: 2px solid #10b981;
        }
        .copy-feedback {
            transition: opacity 0.5s;
        }
    </style>
</head>
<body class="antialiased">
    <div id="app" class="container mx-auto p-4 md:p-8 relative z-10">

        <!-- Hero Section -->
        <header class="text-center py-16 md:py-20 mb-12">
            <h1 class="text-5xl md:text-7xl font-black text-white mb-4">
                متجر <span class="text-green-400">وفرنهالك تك</span>
            </h1>
            <p class="text-lg md:text-xl text-gray-300 max-w-2xl mx-auto mb-10">
                بوابتك إلى عالم الاشتراكات الرقمية. جودة، سرعة، وأمان في مكان واحد.
            </p>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <button onclick="openAiHelperModal()" class="btn-primary font-bold py-3 px-8 text-lg rounded-lg w-full sm:w-auto">
                    ✨ المساعد الذكي
                </button>
                <button id="play-game-btn" onclick="openGameModal()" class="btn-game font-bold py-3 px-8 text-lg rounded-lg w-full sm:w-auto">
                    🎁 العب واربح خصم
                </button>
            </div>
        </header>

        <!-- Why Choose Us Section -->
        <section class="mb-20">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                 <div class="bg-gray-900/50 p-6 rounded-lg border border-gray-800">
                    <div class="text-5xl mb-4">💰</div>
                    <h3 class="text-2xl font-bold text-white mb-2">أسعار تنافسية</h3>
                    <p class="text-gray-400">نضمن لك أفضل قيمة مقابل اشتراكك.</p>
                </div>
                <div class="bg-gray-900/50 p-6 rounded-lg border border-gray-800">
                    <div class="text-5xl mb-4">⚡️</div>
                    <h3 class="text-2xl font-bold text-white mb-2">تسليم فوري</h3>
                    <p class="text-gray-400">استلم اشتراكك فورًا بعد الدفع مباشرة.</p>
                </div>
                <div class="bg-gray-900/50 p-6 rounded-lg border border-gray-800">
                    <div class="text-5xl mb-4">🎧</div>
                    <h3 class="text-2xl font-bold text-white mb-2">دعم فني متميز</h3>
                    <p class="text-gray-400">مستعدون لمساعدتك على مدار الساعة.</p>
                </div>
            </div>
        </section>

        <!-- Products Grid -->
        <main id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Products will be dynamically inserted here -->
        </main>

        <!-- Footer -->
        <footer class="text-center mt-20 text-gray-500 border-t border-gray-800 pt-8">
            <p>&copy; 2024 متجر وفرنهالك تك. جميع الحقوق محفوظة.</p>
        </footer>
    </div>

    <!-- Modals -->
    <!-- Order Modal -->
    <div id="order-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm" onclick="closeOrderModal()"></div>
        <div class="modal-content rounded-xl shadow-2xl w-11/12 max-w-lg m-4 transform transition-all relative" onclick="event.stopPropagation()">
            <div class="p-5 border-b border-gray-700 flex justify-between items-center">
                <h2 id="modal-product-title" class="text-2xl font-bold text-white"></h2>
                <button onclick="closeOrderModal()" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <form id="order-form" class="p-6">
                <input type="hidden" id="product-name-input">
                <div class="mb-4">
                    <label class="block mb-2 font-semibold text-gray-200 text-lg">اختر الباقة:</label>
                    <div id="package-dropdown" class="relative">
                        <button type="button" id="package-button" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-md text-white flex justify-between items-center text-right hover:border-green-500 transition-colors">
                            <span id="selected-package-text" class="truncate"></span>
                             <svg class="w-5 h-5 text-gray-400" id="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="package-options" class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-600 rounded-md shadow-lg hidden max-h-48 overflow-y-auto"></div>
                    </div>
                    <input type="hidden" id="selected-package-input" name="package">
                </div>
                <div class="space-y-3">
                    <input type="text" id="customer-name" placeholder="الاسم" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    <input type="tel" id="customer-phone" placeholder="رقم الواتساب (إجباري)" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    <input type="email" id="customer-email" placeholder="الإيميل (اختياري)" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                    <div>
                        <input type="text" id="discount-code-input" placeholder="كود الخصم (إن وجد)" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-green-500">
                        <p id="code-error" class="text-red-500 text-sm mt-1 hidden"></p>
                        <p id="code-success" class="text-green-400 text-sm mt-1 hidden"></p>
                    </div>
                    <textarea id="customer-notes" rows="2" placeholder="ملاحظات إضافية" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                    <button type="submit" class="w-full btn-primary font-bold py-3 text-lg rounded-lg">إرسال الطلب الآن</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Gemini AI Helper Modal -->
    <div id="ai-helper-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm" onclick="closeAiHelperModal()"></div>
        <div class="modal-content rounded-xl shadow-2xl w-11/12 max-w-2xl m-4 transform transition-all relative flex flex-col" style="max-height: 90vh;">
            <div class="p-5 border-b border-gray-700 flex justify-between items-center">
                <h2 id="ai-modal-title" class="text-2xl font-bold text-white">✨ مساعدك الذكي</h2>
                <button onclick="closeAiHelperModal()" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="ai-modal-content" class="p-6 overflow-y-auto flex-grow"></div>
            <div id="ai-modal-loader" class="p-6 flex-grow hidden items-center justify-center flex-col">
                <div class="loader"></div>
                <p class="mt-4 text-green-400">الذكاء الاصطناعي يجهز لك أفضل توصية...</p>
            </div>
            <div id="ai-modal-form-container" class="p-6 border-t border-gray-700">
                <form id="ai-helper-form">
                    <textarea id="ai-user-prompt" rows="3" class="w-full p-3 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="مثال: أنا مصمم جرافيك وأبحث عن أفضل باقة شاملة..."></textarea>
                    <button type="submit" class="w-full mt-4 btn-primary font-bold py-3 text-lg rounded-lg">احصل على توصية</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Game Modal -->
    <div id="game-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="game-container" class="relative">
            <canvas id="game-canvas" width="400" height="600"></canvas>
            <div id="start-screen" class="absolute inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center text-center p-4">
                <h2 id="start-title" class="text-4xl font-bold text-white mb-4">لعبة الصاروخ</h2>
                <p id="start-subtitle" class="text-white mb-8">انقر للطيران وتفادي الحواجز. اربح كود خصم عند الخسارة!</p>
                <button id="start-game-btn" class="btn-primary font-bold py-3 px-8 text-lg rounded-lg">ابدأ اللعب</button>
                <div id="attempts-left" class="text-amber-400 mt-4 text-lg"></div>
            </div>
             <div id="score-display" class="absolute top-4 right-4 text-white text-3xl font-bold" style="text-shadow: 2px 2px 4px #000;">0</div>
             <button onclick="closeGameModal()" class="absolute top-4 left-4 text-white text-3xl font-bold" style="text-shadow: 2px 2px 4px #000;">&times;</button>
        </div>
    </div>
    
    <!-- Discount/Game Over Modal -->
    <div id="discount-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
         <div class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm"></div>
         <div class="modal-content rounded-xl shadow-2xl w-11/12 max-w-md m-4 transform transition-all relative text-center p-8">
            <h2 id="discount-modal-title" class="text-4xl font-bold text-amber-400 mb-4"></h2>
            <p class="text-white text-lg mb-2">نتيجتك النهائية: <span id="final-score" class="font-bold">0</span></p>
            
            <div id="discount-won-container" class="hidden">
                <p class="text-white text-lg mb-6">لقد ربحت خصمًا رائعًا!</p>
                <div class="bg-gray-900 border-2 border-dashed border-green-400 rounded-lg p-4 my-6">
                    <p class="text-white mb-2">كود الخصم الخاص بك هو:</p>
                    <p id="discount-code" class="text-3xl font-bold text-green-400 tracking-widest"></p>
                </div>
                <div class="relative">
                    <button id="copy-code-btn" class="w-full btn-primary font-bold py-3 text-lg rounded-lg mb-4">انسخ الكود</button>
                    <div id="copy-feedback" class="absolute -bottom-2 right-0 left-0 text-green-400 opacity-0">تم النسخ بنجاح!</div>
                </div>
            </div>

            <div id="no-discount-container" class="hidden">
                 <p class="text-white text-lg my-6">حظ أوفر في المرة القادمة!</p>
            </div>

            <button onclick="closeDiscountModal()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 text-lg rounded-lg mt-4">أغلق النافذة</button>
         </div>
    </div>


    <script>
        // --- DATA (Global) ---
        const products = [
             { id: 'capcut', title: '🎬 CapCut Pro', image: 'https://placehold.co/600x400/000000/10b981?text=CapCut', features: ['إزالة العلامة المائية', 'استخدام قوالب البرو', 'أدوات الذكاء الاصطناعي', 'تخزين سحابي 1 تيرابايت'], packages: [ { name: 'شخصي - 1 شهر (ميل جديد)', price: '499 جنيه' }, { name: 'شخصي - 12 شهر (عرض)', price: '2800 جنيه' }, { name: 'شخصي - 12 شهر (إيميل قديم)', price: '5100 جنيه' } ], notes: 'لأفضل سعر، استخدم إيميل جديد لم يفعل مسبقًا على CapCut.'},
             { id: 'chatgpt', title: '🔥 ChatGPT & Sora AI', image: 'https://placehold.co/600x400/000000/10b981?text=ChatGPT', features: ['دخول GPT-5', '80 Prompt كل 3 ساعات', 'إنشاء فيديوهات بـ Sora', 'دعم الإضافات (Plugins)'], packages: [ { name: 'مشترك - 1 شهر', price: '399 جنيه' }, { name: 'مشترك - 3 شهور', price: '899 جنيه' }, { name: 'مشترك - 12 شهر', price: '2499 جنيه' }, { name: 'شخصي خاص - 1 شهر', price: '1000 جنيه' } ], notes: 'الحسابات المشتركة يتم تسليمها فور الدفع.'},
             { id: 'adobe', title: '🚀 Adobe Creative Cloud', image: 'https://placehold.co/600x400/000000/10b981?text=Adobe', features: ['كل برامج أدوبي', 'تحديثات مستمرة', 'تخزين سحابي', 'يعمل على أجهزتك'], packages: [ { name: '6 شهور', price: '1600 جنيه' }, { name: 'سنة', price: '2700 جنيه' } ], notes: 'الأسعار قابلة للتغيير، تأكد من السعر قبل الدفع.'},
             { id: 'midjourney_runway', title: '🎥 Midjourney & Runway', image: 'https://placehold.co/600x400/000000/10b981?text=AI+Video', features: ['توليد فيديوهات غير محدود', 'إزالة العلامات المائية', 'جودة عالية في الإنتاج', 'وصول لأحدث الموديلات'], packages: [ { name: 'Midjourney/Runway - 1 شهر', price: 'تبدأ من 799 جنيه' } ], notes: 'الحجز بالأسبقية لتكوين المجموعات.'},
             { id: 'freepik_dl', title: '🖥 Freepik (تحميل فقط)', image: 'https://placehold.co/600x400/000000/10b981?text=Freepik', features: ['يشمل Freepik وFlaticon', 'دخول مباشر بيوزر وباسورد', 'يعمل على جهاز واحد', 'تحميل 25 ملف يوميًا'], packages: [ { name: 'مشترك - 3 شهور', price: '800 جنيه' }, { name: 'مشترك - 6 شهور', price: '1300 جنيه' }, { name: 'مشترك - 12 شهر', price: '2200 جنيه' }, ], notes: 'هذه الباقة لا تتضمن نقاط الذكاء الاصطناعي (AI).'},
             { id: 'freepik_ai', title: '🤖 Freepik (تحميل و AI)', image: 'https://placehold.co/600x400/000000/10b981?text=Freepik+AI', features: ['توليد وتعديل لا نهائي للصور', '7000 نقطة AI شهرية', 'تحميل 25 ملف يوميًا', 'يعمل على جهاز واحد'], packages: [ { name: 'مشترك (AI) - 1 شهر', price: '800 جنيه' }, { name: 'فردي Premium - 12 شهر', price: '5400 جنيه' }, { name: 'فردي Premium+ - 12 شهر', price: '13,000 جنيه' } ], notes: 'الاشتراك الفردي يعمل على 3 أجهزة ويشمل نقاط AI أكثر.'},
             { id: 'canva', title: '🎨 Canva Educational (Pro)', image: 'https://placehold.co/600x400/000000/10b981?text=Canva', features: ['تغيير مقاسات التصميم', 'مكتبة ضخمة من القوالب', 'إزالة خلفيات الصور بضغطة', 'تصميم كل شيء بسهولة'], packages: [ { name: 'سنة', price: '250 جنيه' }, { name: '3 سنين', price: '450 جنيه' } ], notes: 'الحل الأمثل لغير المصممين لإنتاج تصاميم احترافية.'},
             { id: 'linkedin', title: '💼 LinkedIn Premium', image: 'https://placehold.co/600x400/000000/10b981?text=LinkedIn', features: ['تفعيل على حسابك الشخصي', 'خصوصية تامة بدعوة خاصة', 'ضمان المدة كاملة'], packages: [ { name: 'Premium Business - 12 شهر', price: '4300 جنيه' }, { name: 'باقات أخرى', price: 'اسأل عن التوفر' } ], notes: 'السعر يتغير يوميًا بسبب قلة التوافر، اسأل قبل الدفع.'},
             { id: 'envato', title: '🔸 Envato Elements', image: 'https://placehold.co/600x400/000000/10b981?text=Envato', features: ['يشمل כל محتوى الموقع', 'تحميل 50-60 ملف يوميًا', 'دخول مباشر بيوزر وباسورد'], packages: [ { name: 'مشترك - 3 أشهر', price: '699 جنيه' }, { name: 'مشترك - 12 شهر', price: '1600 جنيه' }, { name: 'شخصي (8 أجهزة) - 12 شهر', price: '5900 جنيه' } ], notes: 'خصم خاص للحساب الشخصي في حال طلب أكثر من جهاز.'},
             { id: 'elevenlabs', title: '🎙 ElevenLabs Creator', image: 'https://placehold.co/600x400/000000/10b981?text=ElevenLabs', features: [ 'تسليم فوري (Promo Code)', '330,000 كريدت إجمالي', '3 شهور مجانية مدفوعة', 'صالح للحسابات الجديدة فقط' ], packages: [ { name: 'خطة Creator - 3 شهور', price: '1250 جنيه' } ], notes: 'يجب تفعيل الكود خلال 14 يومًا. ضمان كامل على صلاحية الكود.'}
        ];
        const whatsappNumber = "201150580198";

        // --- SCRIPT INITIALIZATION (RUNS AFTER DOM IS LOADED) ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM Elements ---
            const productsGrid = document.getElementById('products-grid');
            const orderModal = document.getElementById('order-modal');
            const gameModal = document.getElementById('game-modal');
            const startScreen = document.getElementById('start-screen');
            const startGameBtn = document.getElementById('start-game-btn');
            const scoreDisplay = document.getElementById('score-display');
            const discountModal = document.getElementById('discount-modal');
            const finalScoreEl = document.getElementById('final-score');
            const discountCodeEl = document.getElementById('discount-code');
            const copyCodeBtn = document.getElementById('copy-code-btn');
            const discountModalTitle = document.getElementById('discount-modal-title');
            const discountWonContainer = document.getElementById('discount-won-container');
            const noDiscountContainer = document.getElementById('no-discount-container');
            const playGameBtn = document.getElementById('play-game-btn');
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            
            // Game Variables
            let bird, pipes, score, gameOver, animationFrameId, attemptsLeft;
            const birdImg = new Image();
            birdImg.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDBGRkZGIiBzdHJva2Utd2lkdGg9IjEuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNNi41IDEzLjVsLTMgMy41TDggMjFsNC00TDEwLjUgMTVsMS41LTFNOSAxbC0xIDEtNyA3IDEgNCA0IDQgMy0xIDctNy0zLTQtMy0zeiIvPjxwYXRoIGQ9Ik0xNSA2bDMgMyIvPjxwYXRoIGQ9Ik0yMiA3bC0zIDcgNC0xIDEtNEw0IDRsNy0zIDQgM3oiLz48L3N2Zz4=';
            
            // --- General Functions ---
            function renderProducts() {
                if(!productsGrid) return;
                productsGrid.innerHTML = products.map(product => `
                    <div class="product-card rounded-lg shadow-lg flex flex-col">
                        <img src="${product.image}" alt="${product.title}" class="w-full h-48 object-cover">
                        <div class="p-6 flex flex-col flex-grow">
                            <h2 class="text-2xl font-bold text-white mb-4">${product.title}</h2>
                            <div class="mb-5 flex-grow"><ul class="space-y-2 text-slate-300">${product.features.map(f => `<li class="flex items-center"><svg class="w-5 h-5 mr-2 ml-1 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>${f}</li>`).join('')}</ul></div>
                            <div class="mt-auto">
                               <p class="text-xs text-amber-300 bg-amber-900/40 p-2 rounded-md mb-5">${product.notes}</p>
                               <button onclick="openOrderModal('${product.id}')" class="w-full btn-primary font-bold py-2.5 text-md rounded-lg">اطلب الآن</button>
                            </div>
                        </div>
                    </div>`).join('');
            }
            window.openOrderModal = function(productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('modal-product-title').textContent = product.title;
                    document.getElementById('product-name-input').value = product.title;
                    const selectedPackageText = document.getElementById('selected-package-text');
                    const packageOptions = document.getElementById('package-options');
                    const selectedPackageInput = document.getElementById('selected-package-input');
                    packageOptions.innerHTML = '';
                    packageOptions.classList.add('hidden');
                    document.getElementById('dropdown-arrow').style.transform = 'rotate(0deg)';
                    const defaultPackage = product.packages[0];
                    const defaultPackageValue = `${defaultPackage.name} - ${defaultPackage.price}`;
                    selectedPackageText.textContent = defaultPackageValue;
                    selectedPackageInput.value = defaultPackageValue;
                    product.packages.forEach(pkg => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'p-3 cursor-pointer hover:bg-gray-700 transition-colors duration-200';
                        const packageValue = `${pkg.name} - ${pkg.price}`;
                        optionDiv.innerHTML = `<span class="font-bold text-white">${pkg.name}</span><span class="text-green-400 float-left">${pkg.price}</span>`;
                        optionDiv.addEventListener('click', () => {
                            selectedPackageText.textContent = packageValue;
                            selectedPackageInput.value = packageValue;
                            packageOptions.classList.add('hidden');
                            document.getElementById('dropdown-arrow').style.transform = 'rotate(0deg)';
                        });
                        packageOptions.appendChild(optionDiv);
                    });
                    orderModal.classList.remove("hidden");
                }
            }
            window.closeOrderModal = function(){ 
                const codeErrorEl = document.getElementById('code-error');
                const codeSuccessEl = document.getElementById('code-success');
                codeErrorEl.classList.add('hidden');
                codeSuccessEl.classList.add('hidden');
                const submitButton = document.getElementById('order-form').querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.textContent = 'إرسال الطلب الآن';
                orderModal.classList.add("hidden"); 
                document.getElementById('order-form').reset(); 
            }
            function handleOrderSubmit(event){
                event.preventDefault();
                const codeErrorEl = document.getElementById('code-error');
                const codeSuccessEl = document.getElementById('code-success');
                const submitButton = document.getElementById('order-form').querySelector('button[type="submit"]');
                codeErrorEl.classList.add('hidden');
                codeSuccessEl.classList.add('hidden');
                const discountCode = document.getElementById("discount-code-input").value.trim();
                
                if (discountCode) {
                    try {
                        const validCodes = JSON.parse(localStorage.getItem('validDiscountCodes')) || {};
                        if (validCodes[discountCode]) {
                            const percentage = validCodes[discountCode];
                            submitButton.disabled = true;
                            submitButton.textContent = 'جاري التحقق...';
                            animateCounter(codeSuccessEl, percentage, 1000).then(() => {
                                finalizeOrder(percentage);
                            });
                        } else {
                            codeErrorEl.textContent = 'كود الخصم غير صحيح أو تم استخدامه.';
                            codeErrorEl.classList.remove('hidden');
                        }
                    } catch (e) {
                        console.error("Failed to access localStorage:", e);
                        finalizeOrder(); // Finalize without discount if local storage fails
                    }
                } else {
                    finalizeOrder();
                }
            }
            function finalizeOrder(discountPercentage = null) {
                const productName = document.getElementById('product-name-input').value;
                const selectedPackage = document.getElementById('selected-package-input').value;
                const customerName = document.getElementById("customer-name").value;
                const customerPhone = document.getElementById("customer-phone").value;
                const customerEmail = document.getElementById("customer-email").value;
                const discountCode = document.getElementById("discount-code-input").value.trim();
                const customerNotes = document.getElementById("customer-notes").value;
                
                let message = `*طلب جديد من متجر وفرنهالك تك*\n\n*المنتج:* ${productName}\n*الباقة المطلوبة:* ${selectedPackage}\n*الاسم:* ${customerName}\n*رقم الواتساب:* ${customerPhone}\n`;
                if (customerEmail) message += `*الإيميل:* ${customerEmail}\n`;
                if (discountPercentage) {
                    message += `*كود الخصم (تم التحقق):* ${discountCode} (${discountPercentage}%)\n`;
                    try {
                        const validCodes = JSON.parse(localStorage.getItem('validDiscountCodes')) || {};
                        delete validCodes[discountCode];
                        localStorage.setItem('validDiscountCodes', JSON.stringify(validCodes));
                    } catch(e) { console.error("Could not remove used code from storage."); }
                }
                if (customerNotes) message += `*ملاحظات:* ${customerNotes}\n\n`;
                message += `برجاء تأكيد الطلب وتوضيح طرق الدفع المتاحة.`;
                
                const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, "_blank");
                closeOrderModal();
            }
            function animateCounter(element, finalValue, duration = 1000) {
                return new Promise(resolve => {
                    element.classList.remove('hidden');
                    let startTimestamp = null;
                    const step = (timestamp) => {
                        if (!startTimestamp) startTimestamp = timestamp;
                        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                        const currentValue = Math.floor(progress * finalValue);
                        element.textContent = `تم التحقق! خصم بنسبة ${currentValue}%`;
                        if (progress < 1) {
                            requestAnimationFrame(step);
                        } else {
                            setTimeout(resolve, 200);
                        }
                    };
                    requestAnimationFrame(step);
                });
            }
            
            // --- Game Functions ---
            function lockGameForToday() {
                 try {
                    const today = new Date().toISOString().split('T')[0];
                    localStorage.setItem('lastPlayDate', today);
                    checkPlayStatus();
                } catch(e) { console.error("Could not access localStorage to set play date."); }
            }
            function checkPlayStatus() {
                try {
                    const lastPlayDate = localStorage.getItem('lastPlayDate');
                    const today = new Date().toISOString().split('T')[0];
                    if (lastPlayDate === today) {
                        playGameBtn.disabled = true;
                        playGameBtn.textContent = 'لقد لعبت اليوم، عد غدًا!';
                    } else {
                        playGameBtn.disabled = false;
                        playGameBtn.textContent = '🎁 العب واربح خصم';
                    }
                } catch(e) {
                     console.error("Could not access localStorage. Game play limit disabled.");
                }
            }
            function resetGameForNewAttempt() {
                bird = { x: 50, y: 150, width: 40, height: 30, velocity: 0, gravity: 0.3, lift: -6 };
                pipes = [];
                score = 0;
                gameOver = false;
                scoreDisplay.textContent = score;
            }
            function gameLoop() {
                if (gameOver) return;
                animationFrameId = requestAnimationFrame(gameLoop);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                bird.velocity += bird.gravity;
                bird.y += bird.velocity;
                ctx.drawImage(birdImg, bird.x, bird.y, bird.width, bird.height);
                
                if (animationFrameId % 90 === 0) {
                    const pipeY = Math.random() * (canvas.height - 250) + 50;
                    pipes.push({ x: canvas.width, y: pipeY, width: 50, gap: 150, passed: false });
                }

                for (let i = pipes.length - 1; i >= 0; i--) {
                    let p = pipes[i];
                    p.x -= 3;
                    ctx.fillStyle = '#059669'; // Green pipes
                    ctx.fillRect(p.x, 0, p.width, p.y);
                    ctx.fillRect(p.x, p.y + p.gap, p.width, canvas.height - p.y - p.gap);
                    
                    if (bird.x < p.x + p.width && bird.x + bird.width > p.x && (bird.y < p.y || bird.y + bird.height > p.y + p.gap)) {
                        endGame(); return;
                    }
                    if (p.x + p.width < bird.x && !p.passed) {
                        score++;
                        scoreDisplay.textContent = score;
                        p.passed = true;
                    }
                    if (p.x + p.width < 0) { pipes.splice(i, 1); }
                }
                
                if (bird.y + bird.height > canvas.height || bird.y < 0) {
                    endGame(); return;
                }
            }
            function startGame() {
                resetGameForNewAttempt();
                startScreen.classList.add('hidden');
                scoreDisplay.classList.remove('hidden');
                animationFrameId = requestAnimationFrame(gameLoop);
            }
            function endGame() {
                if (gameOver) return;
                gameOver = true;
                cancelAnimationFrame(animationFrameId);
                scoreDisplay.classList.add('hidden');
                
                attemptsLeft--;
                
                finalScoreEl.textContent = score;

                if (score > 0) {
                    lockGameForToday();
                    discountModalTitle.textContent = "تهانينا! لقد ربحت خصمًا!";
                    discountWonContainer.classList.remove('hidden');
                    noDiscountContainer.classList.add('hidden');
                    const discountPercentage = Math.floor(Math.random() * (20 - 5 + 1)) + 5;
                    const code = `WIN${discountPercentage}-${Math.random().toString(36).substring(2, 7).toUpperCase()}`;
                    discountCodeEl.textContent = code;
                    try {
                        const validCodes = JSON.parse(localStorage.getItem('validDiscountCodes')) || {};
                        validCodes[code] = discountPercentage;
                        localStorage.setItem('validDiscountCodes', JSON.stringify(validCodes));
                    } catch (e) { console.error("Failed to save discount code to localStorage:", e); }
                
                } else if (attemptsLeft > 0) {
                    document.getElementById('start-title').textContent = 'محاولة أخرى!';
                    document.getElementById('attempts-left').textContent = `تبقى لديك ${attemptsLeft} محاولات.`;
                    startScreen.classList.remove('hidden');
                    return; // Don't show modal yet
                } else {
                    lockGameForToday();
                    discountModalTitle.textContent = "انتهت اللعبة!";
                    noDiscountContainer.classList.remove('hidden');
                    discountWonContainer.classList.add('hidden');
                }
                setTimeout(() => discountModal.classList.remove('hidden'), 500);
            }
            window.openGameModal = function() {
                if(playGameBtn.disabled) return;
                attemptsLeft = 3;
                document.getElementById('start-title').textContent = 'لعبة الصاروخ';
                document.getElementById('start-subtitle').textContent = 'انقر للطيران وتفادي الحواجز. اربح كود خصم عند الخسارة!';
                document.getElementById('attempts-left').textContent = '';
                gameModal.classList.remove('hidden');
                startScreen.classList.remove('hidden');
            }
            window.closeGameModal = function() {
                gameOver = true;
                if(animationFrameId) cancelAnimationFrame(animationFrameId);
                gameModal.classList.add('hidden');
            }
            window.closeDiscountModal = function() {
                discountModal.classList.add('hidden');
                closeGameModal();
                checkPlayStatus();
            }
            function copyToClipboard(text) {
                 const feedback = document.getElementById('copy-feedback');
                 navigator.clipboard.writeText(text).then(() => {
                    feedback.style.opacity = '1';
                    setTimeout(() => { feedback.style.opacity = '0'; }, 2000);
                 });
            }
            
            // --- Event Listeners ---
            startGameBtn.addEventListener('click', startGame);
            canvas.addEventListener('click', () => { if (!gameOver) bird.velocity = bird.lift; });
            copyCodeBtn.addEventListener('click', () => { copyToClipboard(discountCodeEl.textContent); });
            document.getElementById('order-form').addEventListener('submit', handleOrderSubmit);
            
            document.addEventListener('keydown', (event) => {
                if (event.key === "Escape") {
                    if(!orderModal.classList.contains('hidden')) closeOrderModal();
                    if(!gameModal.classList.contains('hidden')) closeGameModal();
                    if(!discountModal.classList.contains('hidden')) closeDiscountModal();
                }
                if (event.code === 'Space') {
                     event.preventDefault();
                    if(!gameModal.classList.contains('hidden') && !startScreen.classList.contains('hidden')) {
                        startGame();
                    } else if (!gameOver && !gameModal.classList.contains('hidden')) {
                        bird.velocity = bird.lift;
                    }
                }
            });

            // --- Initial Render & Checks ---
            renderProducts();
            checkPlayStatus();
        });
    </script>
</body>
</html>

